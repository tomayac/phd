<html>
  <head>    
    <meta charset="utf-8"/>
    <title>Social Media Illustrator</title>
    <link rel="stylesheet" href="main.css" />
    <script src="histogram.js"></script>
  </head>
  <body>
    <h1>Social Media Illustrator</h1>
    <form method="get" id="search_form" onsubmit="return false;">
      <input name="query" id="query" />
      <label for="query">Query</label>
      <input type="submit" value="OK" />
    </form>
    <div id="results"></div>
    <script type="application/javascript">
      (function() {
        var illustrator = {        
          DEBUG: false,
          MEDIA_SERVER: 'http://localhost:8001/search/',
          PROXY_SERVER: 'http://localhost:8001/proxy/',
          THRESHOLD: 5,
          ACCOUNT_FOR_LUMINANCE: true,
          GLOBAL_cols: 4,
          GLOBAL_rows: 4,          
          loaded: {},
          histograms: {},
          tileHistograms: {},
          // checks if all media items are of the given status
          checkIfAllMediaItems: function(status) {
            for (var key in illustrator.loaded) {
              if (illustrator.loaded[key] !== status) {
                return false;
              }
            }  
            return true;
          },
          /**
           * Initialzes the application
           */
          init: function() {
            if (illustrator.DEBUG) console.log('init');
            illustrator.reset();
            
            var searchForm = document.getElementById('search_form');
            searchForm.addEventListener('submit', function(e) {
              if (e.target.nodeName.toLowerCase() !== 'form') {
                return;
              }
              illustrator.reset();
              var query = document.getElementById('query').value;
              illustrator.search(query);
              return false;
            }, false);
          },
          /**
           * Resets all GUI elements
           */
           reset: function reset() {             
             if (illustrator.DEBUG) console.log('reset');
             var resultsDiv = document.getElementById('results');
             resultsDiv.innerHTML = '';
             var query = document.getElementById('query').value;
             query.value = '';      
             illustrator.loaded = {};       
             illustrator.histograms = {};
             illustrator.tileHistograms = {};
           },
          /**
           * Searches for a term on a plethora of social media platforms
           */
          search: function(query) {
            if (illustrator.DEBUG) console.log('search ' + query);
            if (!illustrator.DEBUG) {
              var xhr = new XMLHttpRequest();
              xhr.onreadystatechange = function (e) {
                if (xhr.readyState == 4) {
                  if (xhr.status == 200) {
                    var results = JSON.parse(xhr.responseText);
                    illustrator.render(results);
                  }        
                }
              }
              var url = illustrator.MEDIA_SERVER + 'combined/' +
                  encodeURIComponent(query);
              xhr.open("GET", url, true);
              xhr.send(null);            
            } else {
              var results =
                  typeof output === 'string' ? JSON.parse(output) : output;
              illustrator.render(results);
            }
            return false;
          },
          /**
           * Renders the results
           */
          render: function(results) {
            var resultsDiv = document.getElementById('results');
            for (var service in results) {
              results[service].forEach(function(item) {                
                // media asset
                if (item.type === 'photo') {
                  var image = new Image();
                  image.setAttribute('class', 'photo');
                  var source = illustrator.PROXY_SERVER +
                      encodeURIComponent(item.mediaurl);
                      
                  image.onerror = function() {                      
                    try{
                      image.parentNode.removeChild(image);
                    } catch(e) {
                      // noop
                    }
                    delete illustrator.loaded[source];
                    console.log('Removed ' + image.src);
                  };                  
                  
                  image.onload = function() {
                    image.style.border = 'solid 4px yellow';                    
                    illustrator.loaded[source] = true;
                    illustrator.histogram(image);                    
                  };
                  //resultsDiv.appendChild(image);
                  //resultsDiv.appendChild(document.createTextNode(source));
                  //resultsDiv.appendChild(document.createElement('br'));
                
                  image.src = source;
                  illustrator.loaded[source] = false;                  
                  // make sure the load event fires for cached images too
                  if (image.complete || image.complete === undefined) {
                    image.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
                    image.src = source;
                    image.style.border = 'solid 4px green';
                  }
                }
              });
            }
          },
          histogram: function(img) {
            // draw the image on the canvas
            var canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            var ctx = canvas.getContext('2d');       
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            // calculate the histograms tile-wise 
            var similarityCanvas = document.createElement('canvas');
            ///*
            similarityCanvas.width = img.width;
            similarityCanvas.height = img.height;
            //*/
            //similarityCanvas.width = 100;
            //similarityCanvas.height = 100;
            
            var similarityCtx = similarityCanvas.getContext('2d');

            var sw = ~~(img.width / illustrator.GLOBAL_cols);
            var sh = ~~(img.height / illustrator.GLOBAL_rows);
            var dw = ~~(similarityCanvas.width / illustrator.GLOBAL_cols);
            var dh = ~~(similarityCanvas.height / illustrator.GLOBAL_rows);

            illustrator.histograms[img.src] = {
              r: 0,
              g: 0,
              b: 0
            };
            illustrator.tileHistograms[img.src] = {};
            for (var i = 0; i < illustrator.GLOBAL_rows_x_cols; i++) {
              // calculate the boundaries for the current tile from the
              // image and translate it to boundaries on the main canvas
              var mod = (i % illustrator.GLOBAL_cols);
              var div = ~~(i / illustrator.GLOBAL_cols);
              var sx = mod * sw;
              var sy = div * sh;
              var dx = mod * dw;
              var dy = div * dh;
              // calculate the histogram of the current tile
              var histogram =
                  Histogram.getHistogram(ctx, dx, dy, dw, dh, false);
              illustrator.histograms[img.src].r += histogram.pixel.r;
              illustrator.histograms[img.src].g += histogram.pixel.g;
              illustrator.histograms[img.src].b += histogram.pixel.b;              
              similarityCtx.fillStyle = histogram.css;
              similarityCtx.fillRect(dx, dy, dw, dh);
              
              illustrator.tileHistograms[img.src][i] = {
                r: histogram.pixel.r,
                g: histogram.pixel.g,
                b: histogram.pixel.b
              };
              
            }

            for (var channel in illustrator.histograms[img.src]) {
              illustrator.histograms[img.src][channel] =
                  ~~(illustrator.histograms[img.src][channel] /
                      illustrator.GLOBAL_rows_x_cols);
            }
            illustrator.loaded[img.src] = 'histogram';            
            
            
            //img.parentNode.insertBefore(canvas, img);
            //img.parentNode.insertBefore(similarityCanvas, canvas);            
            //img.parentNode.removeChild(img);
            
            if (illustrator.checkIfAllMediaItems('histogram')) {
              illustrator.sort();
            };
          },
          sort: function() {
            var averageHistograms = [];
            for (var key in illustrator.histograms) {
              averageHistograms.push({
                src: key,
                histogram: illustrator.histograms[key]
              });
            }
            var sortFunction = function(a, b) {
              if (illustrator.ACCOUNT_FOR_LUMINANCE) {
                var rFactor = 0.3;
                var gFactor = 0.59;
                var bFactor = 0.11;
              } else {
                var rFactor = 1;
                var gFactor = 1;
                var bFactor = 1;                
              }
              var rDist = rFactor * (a.histogram.r - b.histogram.r);
              var gDist = gFactor * (a.histogram.g - b.histogram.g);
              var bDist = bFactor * (a.histogram.b - b.histogram.b);
              return rDist + gDist + bDist;
            };            
            averageHistograms.sort(sortFunction);

            var resultsDiv = document.getElementById('results');
            // resultsDiv.innerHTML += '<hr><hr>';
            var html = [];
            averageHistograms.forEach(function(image, i) {
              var img = document.createElement('img');
              html[i] = '<img class="photo" src="' + image.src + '"/>' +
                  '<div style="display:inline; background-color:' +
                  'rgb(' +
                      image.histogram.r + ',' +
                      image.histogram.g + ',' +
                      image.histogram.b + ');width:100px;height:100px;!important">&nbsp;</div>';              
              if (i > 0) {
                var histogramDifferenceR =
                    (image.histogram.r - averageHistograms[i - 1].histogram.r);
                var histogramDifferenceG =                    
                    (image.histogram.g - averageHistograms[i - 1].histogram.g);
                var histogramDifferenceB =                    
                    (image.histogram.b - averageHistograms[i - 1].histogram.b);

                if ((histogramDifferenceR <= illustrator.THRESHOLD) &&
                    (histogramDifferenceG <= illustrator.THRESHOLD) &&
                    (histogramDifferenceB <= illustrator.THRESHOLD)) {                  
                  // noop
                } else {
                  html[i] = '<hr/>' + html[i];
                }               
              }                                
            });
            //resultsDiv.innerHTML += html.join('');
            resultsDiv.innerHTML += '<hr/><hr/><hr/><hr/><hr/><hr/><hr/><hr/>';
            html = [];
            var distances = {};

            var abs = Math.abs;
            var keys = Object.keys(illustrator.tileHistograms);
            var len = keys.length;
            var i = 0;
            var burnt = {};
            var halfOfTiles = ~~(illustrator.GLOBAL_rows_x_cols / 2);
            if (illustrator.ACCOUNT_FOR_LUMINANCE) {
              var rFactor = 0.3;
              var gFactor = 0.59;
              var bFactor = 0.11;
            } else {
              var rFactor = 1;
              var gFactor = 1;
              var bFactor = 1;                
            }            
            for (var outerKey in illustrator.tileHistograms) {                            
              i++;
              if (burnt[outerKey]) {
                continue;
              }
              distances[outerKey] = {};
              var outerHistograms = illustrator.tileHistograms[outerKey];
              html.push('<hr/><a href="' + outerKey + '"><img class="photo" src="' + outerKey + '"/></a>');
              var startAt = 0;
              for (var j = i; j < len; j++) {
                var innerKey = keys[j];
                var innerHistograms = illustrator.tileHistograms[innerKey];
                var rSum = 0;
                var gSum = 0;
                var bSum = 0;
                distances[outerKey][innerKey] = {};
                for (var tile in innerHistograms) {
                  var rDist = rFactor * (innerHistograms[tile].r - outerHistograms[tile].r);
                  var gDist = gFactor * (innerHistograms[tile].g - outerHistograms[tile].g);
                  var bDist = bFactor * (innerHistograms[tile].b - outerHistograms[tile].b);
                  distances[outerKey][innerKey][tile] = {
                    r: rDist,
                    g: gDist,
                    b: bDist
                  };
                  rSum += rDist;
                  gSum += gDist;
                  bSum += bDist;
                }                
                distances[outerKey][innerKey].average = {
                  r: ~~(rSum / illustrator.GLOBAL_rows_x_cols),
                  g: ~~(gSum / illustrator.GLOBAL_rows_x_cols),
                  b: ~~(bSum / illustrator.GLOBAL_rows_x_cols)
                };
                var similarTiles = 0;
                for (var tile in distances[outerKey][innerKey]) {
                  /*
                  if ((distances[outerKey][innerKey].average.r <= illustrator.THRESHOLD) &&
                      (distances[outerKey][innerKey].average.g <= illustrator.THRESHOLD) &&
                      (distances[outerKey][innerKey].average.b <= illustrator.THRESHOLD)) {
                    html.push('<img class="photo" src="' + innerKey + '"/>');
                    //resultsDiv.innerHTML += innerKey;                      
                  }
                  */
                  if ((abs(distances[outerKey][innerKey][tile].r) <= illustrator.THRESHOLD) &&
                      (abs(distances[outerKey][innerKey][tile].g) <= illustrator.THRESHOLD) &&
                      (abs(distances[outerKey][innerKey][tile].b) <= illustrator.THRESHOLD)) {
                    similarTiles++;
                  }
                }
                if (similarTiles > halfOfTiles) {
                  burnt[innerKey] = true;
                  html.push('<a href="' + innerKey + '"><img class="photo" src="' + innerKey + '"/></a>');
                }
              }
            }
            resultsDiv.innerHTML += html.join('');
            console.log(distances);            
          }
        };
            
        // init
        illustrator.GLOBAL_rows_x_cols =
            illustrator.GLOBAL_cols * illustrator.GLOBAL_rows;        
        illustrator.init();
      })();      
    </script>
  </body>
</html>